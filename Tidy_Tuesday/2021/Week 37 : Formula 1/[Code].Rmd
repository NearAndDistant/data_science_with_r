---
title: "Formula 1"
author: "NearAndDistant"
date: "07/09/2021"
output: html_document
---

Adding power makes you faster on the straights. Subtracting weight makes you faster everywhere.
- Colin Chapman

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Glue
Glue offers interpreted string literals that are small, fast, and dependency-free. Glue does this by embedding R expressions in curly braces which are then evaluated and inserted into the argument string. We can use this to dynamically call the Ergast API. For instance:

name <- "Fred"
glue::glue('My name is {name}.')

#### Dynamically Import from Ergast API using Glue
```{r}
library(tidyverse)
library(jsonlite)
library(httr)

ergast_url <- "http://ergast.com/api/f1/{api_ask}.json?limit=5000"

api_ask <- "drivers"

raw_json_drivers_info <- 
  httr::GET(glue::glue(ergast_url)) %>% 
  content(type = "text", encoding = "UTF-8") %>% 
  jsonlite::parse_json(simplifyVector = FALSE)

```

#### Rectangling and tidyr
Rectangling is the art and craft of taking a deeply nested list (often sourced from wild caught JSON or XML) and taming it into a tidy data set of rows and columns. There are three functions from tidyr that are particularly useful for rectangling:

unnest_longer() takes each element of a list-column and makes a new row.
unnest_wider() takes each element of a list-column and makes a new column.
unnest_auto() guesses whether you want unnest_longer() or unnest_wider().

hoist() is similar to unnest_wider() but only plucks out selected components, and can reach down multiple levels. A very large number of data rectangling problems can be solved by combining these functions with a splash of dplyr.

```{r}
library(listviewer)

# creates interactive json map so we can see where we are
jsonedit(raw_json_standings)

```

#### Driver Info Table
```{r}

# create tibble of list of lists to unnest
json_drivers <- tibble(drivers = raw_json_drivers_info$MRData$DriverTable)

# unnest tibble into unnested lists then widen
drivers_info <- 
json_drivers %>%
  unnest_longer(drivers) %>% 
  unnest_wider(drivers) %>%
  select(-url) # we do not need Wikipedia entries for this project

```

##### Drivers Info: Graphic
```{r}
theme_set(theme_minimal())

drivers_info %>%
  count(nationality) %>%
  ggplot(aes(n , reorder(nationality, n), fill = nationality)) +
  geom_col(show.legend = FALSE) +
  labs(y = NULL)

```

#### F1 Seasons
```{r}

api_ask <- "seasons"

raw_json_seasons <- 
  httr::GET(glue::glue(ergast_url)) %>% 
  content(type = "text", encoding = "UTF-8") %>% 
  jsonlite::parse_json(simplifyVector = FALSE) 

json_seasons <- tibble(season = raw_json_seasons$MRData$SeasonTable)

seasons <- 
json_seasons %>%
  unnest_longer(season) %>% 
  unnest_wider(season) %>%
  select(-url)

```

#### Driver Standing Table
```{r}

seasons_vector <- unlist(seasons[1:6,])

season_list_master <- as_tibble()

for(i in seasons_vector)
{
api_ask <- paste0(i,"/driverStandings")

raw_json_standings <- 
  httr::GET(glue::glue(ergast_url)) %>% 
  content(type = "text", encoding = "UTF-8") %>% 
  jsonlite::parse_json(simplifyVector = FALSE) 

# create tibble of list of lists to unnest
season_list <- tibble(season = raw_json_standings$MRData$StandingsTable$StandingsLists[[1]]$DriverStandings)

# unnest tibble into unnested lists then widen
season_list <- season_list %>% unnest_wider(season) %>% mutate(season = i)

season_list_master <- rbind(season_list_master , season_list)
}

```


```{r}

driver_standings <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-09-07/driver_standings.csv')

api_ask <- "constructorStandings"

raw_json_c_standing <- 
  httr::GET(glue::glue(ergast_url)) %>% 
  content(type = "text", encoding = "UTF-8") %>% 
  jsonlite::parse_json(simplifyVector = FALSE) 

```


