---
title: '#30DayMapChallenge'
author: "NearAndDistant"
date: "04/11/2021"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

# Packages
library(tidyverse)
library(osmdata)
library(rgdal)

library(cowplot)
library(showtext); showtext_auto()

dir.create(here::here("graphics"))

```

# 30 Day Map Challenge

# Day 01 : Points (London Postboxes)
```{r}

# boundary box
coords <- matrix(c(-0.6, 0.35, 51.22, 51.75), # org: -0.8, 0.5, 51.2, 51.75
                 byrow = TRUE, nrow = 2, ncol = 2, 
                 dimnames = list(c('x','y'),c('min','max'))) 

location <- coords %>% opq()

# postbox data
postbox <- 
location %>%
   add_osm_feature(key = "amenity", value = "post_box") %>%
   osmdata_sf()

highway <- 
  location %>%
  add_osm_feature(key = "highway", 
                  value = c("motorway", "primary", "motorway_link", "primary_link")) %>%
  osmdata_sf()

streets <-
  location %>%
  add_osm_feature(key = "highway", value = c("residential", "living_street")) %>%
  osmdata_sf()

```

```{r map , echo = FALSE , fig.align = 'center' , fig.dim = '125%' , message = FALSE}
library(sf)

# create temp files
temp_map <- tempfile(fileext = ".zip")
unzip_temp_map <- tempfile()

# download zip file into tempfile using hyperlink
download.file(url = "https://s3-eu-west-1.amazonaws.com/londondatastore-upload/statistical-gis-boundaries-london.zip", destfile = temp_map)

# unzip the tempfile to extract the shp file we need
unzip_temp_map <- unzip(temp_map)

# read shp file using read_sf
lnd_shp <- 
  read_sf('statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp') %>%
    janitor::clean_names() %>%
    select(name , code_ons = gss_code , geometry)

```

```{r}

library(showtext); showtext_auto()
font_add_google("Righteous", "righteous")
font_add_google("Saira" , "saira")

text <- str_wrap('The advent of the British wayside letter box can be traced to Sir Rowland Hill, Secretary of the Post Office, and his Surveyor for the Western District, and noted novelist, Anthony Trollope. Hill sent Trollope to the Channel Islands to ascertain what could be done about the problem of collecting the mail on a pair of islands. The problems identified in the Channel Islands were caused by the irregular sailing times of the Royal Mail packet boats serving the islands due to weather and tides. Trollope subsequently arrived in Jersey in the early Spring of 1852 and proceeded to survey both islands. His recommendation back to Hill was to employ a device he may have seen in use in Paris: a "letter-receiving pillar".', width = 100)

# lnd map
plot_lnd_pb <-
ggplot() +
  geom_sf(data = lnd_shp, fill = "white", color = "#41424C", alpha = 0.8) +
    geom_sf(data = streets$osm_lines, inherit.aes = FALSE,
            color = "#ADADC9", size = .6, alpha = .7) +
    geom_sf(data = highway$osm_lines, inherit.aes = FALSE,
            color = "#787276", size = .6, alpha = .7) +
  geom_sf(data = postbox$osm_points, 
          color = "#df2a2a", size = 0.1, alpha = 0.8) +
  theme_void() +
  theme(plot.background  = element_rect(fill = "#41424C", color = "#41424C"),
        panel.background = element_rect(fill = "#41424C", color = "#41424C"),
        plot.margin = margin(0,0,4,0,unit = "cm"))

library(cowplot)

panel_lnd_pb <-
ggdraw() +
  draw_plot(plot_lnd_pb) +
  draw_text("The London Postbox", x = 0.08 , y = 0.95 , hjust = 0, color = "white", size = 36, family = "righteous") +
  draw_text("Data: Open Street Map | Graphic: @NearAndDistant", x = 0.08 , y = 0.915 , hjust = 0, color = "white", size = 10, family = "righteous") +
  draw_text(text , x = 0.08 , y = 0.12, size = 12, color = "white", hjust = 0, family = "saira")

```

#### Saving
```{r}

ggsave(plot = panel_lnd_pb, filename = here::here("graphics/D1_London_Postbox.png"), dpi = 360, height = 10.2, width = 8.75)

```

# Day 02 : Lines

```{r}

# boundary box
d2_coords <- matrix(c(-1.794891,54.920434,-1.334839,55.069719),
                 byrow = FALSE, nrow = 2, ncol = 2, 
                 dimnames = list(c('x','y'),c('min','max'))) 

d2_location <- d2_coords %>% opq()

# boundary box & features
d2_main_st <- 
  d2_location %>%
  add_osm_feature(key = "highway",
                  value = c("motorway","trunk","primary","motorway_junction","trunk_link","primary_link","motorway_link")) %>%
  osmdata_sf()

d2_res <-
  d2_location %>%
  add_osm_feature(key = "highway", 
                  value = c("residential", "living_street")) %>%
  osmdata_sf()

rail <- available_tags("railway")

d2_rail <- 
  d2_location %>%
  add_osm_feature(key = "railway",
                  value = rail) %>%
  osmdata_sf()

d2_bus <-
  d2_location %>%
  add_osm_feature(key = "route",
                  value = c("bus")) %>%
  osmdata_sf()

d2_water <-
  d2_location %>%
  add_osm_feature(key = "natural",
                  value = c("water", "coastline")) %>%
  osmdata_sf()

d2_river <-
  d2_location %>%
  add_osm_feature(key = "waterway",
                  value = c("river", "riverbank", "stream")) %>%
  osmdata_sf()

bg <- "white"

# plot
ggplot() +
    geom_sf(data = d2_water$osm_polygons, inherit.aes = FALSE,
            fill = "#1F456E", size = .6, alpha = 0.8) +
    geom_sf(data = d2_water$osm_multipolygons, inherit.aes = FALSE,
            fill = "#1F456E", size = .6, alpha = 0.8) +
    geom_sf(data = d2_main_st$osm_lines, inherit.aes = FALSE,
            color = "black", size = .6, alpha = .8) +
    geom_sf(data = d2_res$osm_lines, inherit.aes = FALSE,
            color = "black", size = .6, alpha = .3) +
    geom_sf(data = d2_rail$osm_lines, inherit.aes = FALSE,
            color = "#BE5504", size = .6, alpha = 0.8) +
    geom_sf(data = d2_bus$osm_lines, inherit.aes = FALSE,
            color = "#637C98", size = .6, alpha = 0.8) +
  coord_sf(xlim = c(-1.75, -1.18), ylim = c(54.88, 55.075)) +
  theme_void() +
  theme(plot.background  = element_rect(fill = bg, color = bg),
        panel.background = element_rect(fill = bg, color = bg))

```

```{r}

uk_lads <- 
  readOGR( 
  dsn = here::here("Local_Authority_Districts"), 
  layer ="LAD_MAY_2021_UK_BFE_V2",
  verbose=FALSE)

uk_lads_tidy <- broom::tidy(uk_lads, region = "LAD21NM")

ggplot() +
  geom_polygon(data = uk_lads_tidy , 
               aes(lat, lat, group = group), 
               color = "#FFFFFF", size = 0.25) +
  coord_fixed(1)

```


# Day 03 : Polygons

```{r}

```


# Day 04 : Hexagons

```{r}
# data source, % benefits: https://dashboards.instantatlas.com/viewer/report?appid=b0aa98ed7113440581b4b3513ebb6e3d

man_bens_raw <- readxl::read_xlsx(here::here("Area_Profile_Data_-_November_2021.xlsx"), sheet = "Benefits DWP (February 2021)")

man_bens <-
  man_bens_raw %>%
  filter(Area == "Ward") %>%
  select(ward = "Area Name" , pc_out_work_bens = "Percentage of residents claiming out of work benefits") %>%
  mutate(pc_out_work_bens = pc_out_work_bens/100)

```

```{r}
# boundaries
# boundary source: https://osdatahub.os.uk/downloads/open/BoundaryLine

library(sf)
library(geogrid)

uk_bound <- 
  readOGR( 
  dsn = here::here("bdline_essh_gb/Data/GB"), 
  layer = "district_borough_unitary_ward_region",
  verbose=FALSE)

# convert to sf
uk_bound_sf <- st_as_sf(uk_bound)

man_bound_cln <-
  uk_bound_sf %>%
  filter(FILE_NAME == "MANCHESTER_DISTRICT_(B)")

```

```{r}
# calculate hexabin polygons

par(mfrow = c(2, 3), mar = c(0, 0, 2, 0))

# choose from output which is the most representative
for (i in 1:6) {
  new_cells <- calculate_grid(shape = man_bound_cln, grid_type = "hexagonal", seed = i)
  plot(new_cells, main = paste("Seed", i, sep = " "))
}

man_sf_hex <- calculate_grid(shape = man_bound_cln, grid_type = "hexagonal", seed = 6) # seed = chosen 
man_hex    <- assign_polygons(man_bound_cln, man_sf_hex)
  
```

```{r}

man_hex_bens <-
  man_hex %>%
  janitor::clean_names() %>%
  mutate(name = str_remove(name, "Ward"),
         name = trimws(name)) %>%
  rename(ward = "name") %>%
  select(ward , geometry, centroix, centroiy) %>%
  full_join(man_bens , by = "ward")

```

```{r}
# plot
font_add_google("Graduate", "graduate")

text1 <- str_wrap("The Manchester worker bee is one of the best-known symbols of Manchester and has been an emblem for the city for over 150 years. The bee denotes Mancunians' hard work ethic and the city being a hive of activity. It has also come to represent the sense of unity", 40)

text2 <- str_wrap("This hexamap shows the percentage of Mancunians still recieving out of work benefits in 2021 according to the Department of Work and Pensions (DWP). Unemployment in the North of England has consistently being above The South and the Pandemic has only furthered these inequalities.", 40)

plot_manchester <-
ggdraw(
man_hex_bens %>%
  ggplot() +
  geom_sf(aes(geometry = geometry, fill = pc_out_work_bens), color = "white") +
  #ggrepel::geom_label_repel(aes(label = ward, x = centroix, y = centroiy), size = 3) +
  rcartocolor::scale_fill_carto_c(palette = "PinkYl", labels = scales::percent_format(accuracy = 2)) +
  labs(fill = "% of Ward Population Receiving\nOut of Work Benefits") +
  theme_void() +
  theme(legend.position = c(0.75,0.015),
        legend.direction = "horizontal",
        legend.title.align = c(1),
        legend.title = element_text(family = "graduate"),
        legend.key.width = unit(1.5, "cm"),
        plot.margin = margin(0,-1,1,-4, unit = "cm"))) +
draw_image("https://i.etsystatic.com/14593570/r/il/be970c/1293079357/il_570xN.1293079357_kvsv.jpg",
           height = 0.15, width = 0.15, x = 0.35, y = 0.22) +
draw_text("Manchester\nand the\nWorker Bee" , x = 0.565, y = 0.45, hjust = 0, family = "graduate", size = 28) +
draw_text(text1, size = 8, x = 0.565, y = 0.30, hjust = 0, family = "graduate") +
draw_text(text2, size = 8, x = 0.565, y = 0.155, hjust = 0, family = "graduate")
         
```

#### Saving
```{r}

ggsave(plot = plot_manchester, filename = here::here("graphics/D3_Manchester_Bee.jpeg"), dpi = 360, height = 10.2, width = 7)

```

# Day 05 : Open Street Map (Greenspace: Edinburgh vs London )

```{r}
# view features: www.openstreetmap.org
# feature bible: https://wiki.openstreetmap.org/wiki/Map_features#Boundary_types
# feature: https://rforjournalists.com/2020/12/15/how-to-access-open-street-map-in-r/

# circular borders
# https://taraskaduk.com/posts/2021-01-18-print-street-maps/
# https://stackoverflow.com/questions/57184346/r-map-zoom-function-making-the-plot-a-circle-rather-than-a-square

################################
Edinburgh
################################

# boundary box
d5_coords <- matrix(c(-3.336754,55.887443,-3.094711,55.997421),
                 byrow = FALSE, nrow = 2, ncol = 2, 
                 dimnames = list(c('x','y'),c('min','max'))) 

d5_location <- d5_coords %>% opq()

# features
d5_res <- 
  d5_location %>%
  add_osm_feature(key = "highway",
                  value = c("motorway","trunk","primary","motorway_junction","trunk_link","primary_link","motorway_link",
                            "residential", "living_street")) %>%
  osmdata_sf()

d5_rail <-
  d5_location %>%
  add_osm_feature(key = "railway", value = c("rail", "platform", "station")) %>%
  osmdata_sf() 

d5_grassland <- 
  d5_location %>%
  add_osm_feature(key = "landuse", 
                  value = c("grass", "greenfield", "recreation_ground", "meadow", "forest")) %>%
  osmdata_sf()

d5_natural <-
  d5_location %>%
  add_osm_feature(key = "natural", 
                  value = c("wood", "tree_row", "tree", "scrub", "heath", "moor", "grassland", "fell")) %>%
  osmdata_sf()

d5_water <-
  d5_location %>%
  add_osm_feature(key = "natural", value = c("water", "bay", "coastline")) %>%
  osmdata_sf() 


#################################################### circle cutout
# https://epsg.io/4326
crs2 <- 6384 
center = c(long = -3.188438, lat = 55.954966)  

center_proj <-
  tibble(lat = center["lat"], long = center["long"]) %>%
  st_as_sf(coords = c("long", "lat"), crs = 4326)

dist   <- 5500
circle <- 
  tibble(lat = center["lat"], long = center["long"]) %>%
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>%
  st_transform(crs = crs2) %>%
  st_buffer(dist = dist) %>%
  st_transform(crs = 4326)

circle_res      <- st_intersection(circle, d5_res$osm_lines)
circle_grass    <- st_intersection(circle, d5_grassland$osm_polygons)
circle_natural  <- st_intersection(circle, d5_natural$osm_polygons)
circle_water    <- st_intersection(circle, d5_water$osm_multipolygons)
circle_rail     <- st_intersection(circle, d5_rail$osm_lines)

####################################################### plot
d5_bg    <- "white"
d5_green <- "#466D1D" # #32612D

plot_edinburgh <-
ggplot() +
    geom_sf(data = circle_res,     fill = "black",  color = "black", alpha = 0.4) +
    geom_sf(data = circle_rail,    fill = "black", color = "black", size = 0.7, alpha = 1) +
    geom_sf(data = circle_grass,   fill = d5_green, color = d5_green, size = 0.1, alpha = 0.6) +
    geom_sf(data = circle_natural, fill = d5_green, color = d5_green, size = 0.1, alpha = 0.6) +
    geom_sf(data = circle_water,   fill = "#91B2C7", lwd = 0, alpha = 0.3) +
    geom_sf(data = circle, color = "black", fill = NA) +
  theme_void() +
  theme(plot.background  = element_rect(fill = d5_bg, color = d5_bg),
        panel.background = element_rect(fill = d5_bg, color = d5_bg))

```


```{r}
font_add_google("Prata", "prata")

d5_text <- str_wrap("Edinburgh is built upon an extinct volcano, which erupted around 340 million years ago. In the hundreds of millions of years since it stopped erupting, the volcano has been buried beneath other rocks. It has gradually been exposed at the surface and eroded, so that now less than half remains. This means that we can now walk through the crater area and across some of the lava flows, But also go right through the heart of the volcano at Arthur's Seat and see rocks that were created underground during the eruptions.", 20)

panel_edinburgh <-
ggdraw(xlim = c(0,0.4)) +
  draw_plot(plot_edinburgh, x = -0.135, y = 0.08, height = 0.80, width = 0.60) +
  draw_text("Edinburgh, Scotland\n55.9441° N, 3.1618° W", 
            hjust = 0, x = 0.25, y = 0.86, size = 32, family = "prata", fontface = "bold") +
  draw_text(d5_text, 
            hjust = 1, x = 0.39, y = 0.45, size = 16, family = "prata") +
  draw_text("Data:\nOpenStreetMap.org\nGraphic:\n@NearAndDistant", 
            hjust = 0, x = 0.26, y = 0.14, size = 10, family = "prata") +
  draw_image("https://www.onlygfx.com/wp-content/uploads/2018/07/8-grunge-x-1-1024x1006.png",
             height = 0.005, width = 0.005, x = 0.2025, y = 0.455)

```

#### Saving
```{r}

ggsave(plot = panel_edinburgh, filename = here::here("graphics/D5_Edinburgh.jpeg"), dpi = 360, height = 13.5, width = 12.8)

```


# Day 06 : Red

```{r}

```


# Day 07 : Green

```{r}

```


# Day 08 : Blue

```{r}

```


# Day 09 : Monochrome

```{r}

```


# Day 10 : Raster

```{r}

https://osdatahub.os.uk/downloads/open/250kScaleColourRaster

```


# Day 11 : 3D

```{r}

```


# Day 12 : Population

```{r}

```


# Day 13 : Natural Earth

```{r}

```


# Day 14 : New Tool

```{r}

```


# Day 15 : No Computer Map

```{r}

```


# Day 16 : Urban / Rural

```{r}

```


# Day 17 : Land

```{r}

```


# Day 18 : Water, Scotland Lochs

```{r}

# boundary box
coords <- matrix(c(-1.311150,-1.800385,54.912541,55.074043), # -1.800385,54.912541,-1.311150,55.074043
                 byrow = TRUE, nrow = 2, ncol = 2, 
                 dimnames = list(c('x','y'),c('min','max'))) 

location <- coords %>% opq()

# get map
water <- 
location %>%
   add_osm_feature(key = "natural", 
                   value = c("water")) %>%
   osmdata_sf()

# plot
ggplot() + 
  geom_sf(data = water$osm_multipolygons, fill = 'light blue') + 
  theme_minimal()

# data from: https://osdatahub.os.uk/downloads/open/OpenRivers
# coord ref : st_transform(4326)

# Lake District boundary box
d2_coords <- matrix(c(-3.444214,54.281262,-2.672424,54.730964),
                    byrow = FALSE, nrow = 2, ncol = 2, 
                    dimnames = list(c('x','y'),c('min','max'))) 

d2_shp_node <- 
  readOGR( 
  dsn= here::here("oprvrs_essh_gb/data"), 
  layer="HydroNode",
  verbose=FALSE)

d2_shp_link <- 
  readOGR( 
  dsn= here::here("oprvrs_essh_gb/data"), 
  layer="WatercourseLink",
  verbose=FALSE) 

plot(d2_shp_link, color = "#1F456E")

```


# Day 19 : Island

```{r}

```


# Day 20 : Movement

```{r}

```


# Day 21 : Elevation

```{r}

```


# Day 22 : Boundaries

```{r}

```


# Day 23 : GHSL

```{r}

```


# Day 24 : Historical

```{r}

```


# Day 25 : Interactive

```{r}

```


# Day 26 : Chloropleth

```{r}

```


# Day 27 : Heatmap

```{r}

```


# Day 28 : Earth in not Flat

```{r}

```


# Day 29 : NULL

```{r}

```


# Day 30 : Metamapping

```{r}

```


#### Useful Snippets

```{r}
library(ggmap)

# boundary box
bbox <- c(-1.800385,54.912541,-1.311150,55.074043)

# london map
map            <- get_stamenmap(bbox, maptype = "terrain"      , zoom = 11)
map_ton        <- get_stamenmap(bbox, maptype = "toner-lines"  , zoom = 11)
map_terrain    <- get_stamenmap(bbox, maptype = "terrain-lines", zoom = 11)
map_hybrid     <- get_stamenmap(bbox, maptype = "toner-hybrid" , zoom = 12)
map_watercolor <- get_stamenmap(bbox, maptype = "watercolor"   , zoom = 11)

# plot map
ggmap(map_hybrid, extent = "device")

```